{
	"Description": "Main Template",
	"Mappings": {
		"AMIFromRegion": {
			"us-east-1": {
				"QualixAMI": "ami-a248c6b5",
				"ESAMI": "ami-b0941da7",
				"NatAMI": "ami-4868ab25"
			},
			"eu-west-1": {
				"QualixAMI": "ami-cd1774be",
				"ESAMI": "ami-ac2945df",
				"NatAMI": "ami-a8dd45db"
			},
			"us-west-2": {
				"QualixAMI": "ami-fa16db9a",
				"ESAMI": "ami-d26ea3b2",
				"NatAMI": "ami-a275b1c2"
			},							
			"ap-south-1": {
				"QualixAMI": "ami-fa16db9a",
				"ESAMI": "ami-d26ea3b2",
				"NatAMI": "ami-e2b9d38d"
			},			`																		
			"ap-northeast-2": {
				"QualixAMI": "ami-fa16db9a",
				"ESAMI": "ami-d26ea3b2",
				"NatAMI": "ami-d14388bf"
			},													
			"ap-southeast-1": {
				"QualixAMI": "ami-fa16db9a",
				"ESAMI": "ami-d26ea3b2",
				"NatAMI": "ami-a79b49c4"
			},			
			"ap-southeast-2": {
				"QualixAMI": "ami-fa16db9a",
				"ESAMI": "ami-d26ea3b2",
				"NatAMI": "ami-53371f30"
			},		
			"ap-northeast-1": {
				"QualixAMI": "ami-fa16db9a",
				"ESAMI": "ami-d26ea3b2",
				"NatAMI": "ami-2443b745"
			},
			"eu-central-1": {
				"QualixAMI": "ami-fa16db9a",
				"ESAMI": "ami-d26ea3b2",
				"NatAMI": "ami-5825cd37"
			},														
			"sa-east-1": {
				"QualixAMI": "ami-fa16db9a",
				"ESAMI": "ami-d26ea3b2",
				"NatAMI": "ami-9336bcff"
			},													
		},
		"AZFromRegion": {
			"us-east-1": {
				"AZ": "us-east-1a"
			},
			"us-west-2": {
				"AZ": "us-west-2a"
			},
			"us-west-1": {
				"AZ": "us-west-1b"
			},
			"eu-west-1": {
				"AZ": "eu-west-1c"
			},
			"eu-central-1": {
				"AZ": "eu-central-1b"
			},
			"ap-southeast-1": {
				"AZ": "ap-southeast-1a"
			},
			"ap-northeast-1": {
				"AZ": "ap-northeast-1a"
			},
			"ap-southeast-2": {
				"AZ": "ap-southeast-2a"
			},
			"ap-northeast-2": {
				"AZ": "ap-northeast-2a"
			},
			"sa-east-1": {
				"AZ": "us-west-1a"
			},
			"ap-south-1": {
				"AZ": "ap-south-1a"
			}
		}
	},
	"Parameters": {
		"1VPCCIDR": {
			"Type": "String",
			"Description": "IP Address range for Management VPC",
			"MinLength": "9",
			"MaxLength": "18",
			"Default": "10.0.0.0/24",
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
		},
		"2ESCIDR": {
			"Type": "String",
			"Description": "Must be inside VPC CIDR",
			"MinLength": "9",
			"MaxLength": "18",
			"Default": "10.0.0.0/28",
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x, inside VPC CIDR"
		},
		"6VPNAddress": {
			"Type": "String",
			"Description": "IP Address of your router",
			"MinLength": "7",
			"MaxLength": "15",
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
			"ConstraintDescription": "must be a valid IP address of the form x.x.x.x"
		},
		"5OnPremiseCIDR": {
			"Type": "String",
			"Description": "IP Address address range of a network behind the router",
			"MinLength": "9",
			"MaxLength": "18",
			"Default": "192.168.1.0/24",
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
		},
		"ZServerIP": {
			"Type": "String",
			"Description": "IP Address of your CloudShell Server",
			"MinLength": "7",
			"MaxLength": "15",
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
			"ConstraintDescription": "must be a valid IP address of the form x.x.x.x"
		},
		"3NATCIDR": {
			"Type": "String",
			"Description": "Must be inside VPC CIDR",
			"MinLength": "9",
			"MaxLength": "18",
			"Default": "10.0.0.16/28",
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x, inside VPC CIDR"
		},
		"7KeyPair": {
			"Type": "AWS::EC2::KeyPair::KeyName",
			"Description": "Choose the Keypair for the instances"
		},
		"4QualiCIDR": {
			"Type": "String",
			"Description": "Must be inside VPC CIDR",
			"MinLength": "9",
			"MaxLength": "18",
			"Default": "10.0.0.32/28",
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x, inside VPC CIDR"
		},
		"ZUsername": {
			"Type": "String",
			"Description": "Username for CloudShell server"
		},
		"ZPassword": {
			"Type": "String",
			"Description": "Password for CloudShell server",
			"NoEcho": true
		}
	},
	"Resources": {
		"VPCNAT": {
			"Type": "AWS::CloudFormation::Stack",
			"Properties": {
				"TemplateURL": "https://s3.amazonaws.com/cloudshell-cf/1_VPC.json",
				"Parameters": {
					"VPCCIDR": {
						"Ref": "1VPCCIDR"
					},
					"ESCIDR": {
						"Ref": "2ESCIDR"
					},
					"VPNAddress": {
						"Ref": "6VPNAddress"
					},
					"OnPremiseCIDR": {
						"Ref": "5OnPremiseCIDR"
					},
					"ServerIP": {
						"Ref": "ZServerIP"
					},
					"NATCIDR": {
						"Ref": "3NATCIDR"
					},
					"KeyPair": {
						"Ref": "7KeyPair"
					},
					"QualiCIDR": {
						"Ref": "4QualiCIDR"
					},
					"AZ": {
						"Fn::FindInMap": ["AZFromRegion",
						{
							"Ref": "AWS::Region"
						},
						"AZ"]
					},
					"NatAMI": {
						"Fn::FindInMap": ["AMIFromRegion",
						{
							"Ref": "AWS::Region"
						},
						"NatAMI"]
					}
				}
			}
		},
		"Instances": {
			"Type": "AWS::CloudFormation::Stack",
			"Properties": {
				"Parameters": {
					"QualixSN": {
						"Fn::GetAtt": ["VPCNAT",
						"Outputs.QualixSN"]
					},
					"ESInstanceSN": {
						"Fn::GetAtt": ["VPCNAT",
						"Outputs.ESInstanceSN"]
					},
					"QualiXInstanceProfile": {
						"Fn::GetAtt": ["VPCNAT",
						"Outputs.QualiXInstanceProfile"]
					},
					"ESInstanceProfile": {
						"Fn::GetAtt": ["VPCNAT",
						"Outputs.ESInstanceProfile"]
					},
					"SG1id": {
						"Fn::GetAtt": ["VPCNAT",
						"Outputs.SG1id"]
					},
					"SG2id": {
						"Fn::GetAtt": ["VPCNAT",
						"Outputs.SG2id"]
					},
					"QualixAMI": {
						"Fn::FindInMap": ["AMIFromRegion",
						{
							"Ref": "AWS::Region"
						},
						"QualixAMI"]
					},
					"ESAMI": {
						"Fn::FindInMap": ["AMIFromRegion",
						{
							"Ref": "AWS::Region"
						},
						"ESAMI"]
					},
					"KeyPair": {
						"Ref": "7KeyPair"
					},
					"ESInstance2Profile": {
						"Fn::GetAtt": ["VPCNAT",
						"Outputs.ESInstance2Profile"]
					},
					"ServerIP": {
						"Ref": "ZServerIP"
					},
					"ZUsername": {
						"Ref": "ZUsername"
					},
					"ZPassword": {
						"Ref": "ZPassword"
					}
				},
				"TemplateURL": "https://s3.amazonaws.com/cloudshell-cf/2_EC2.json"
			}
		}
	},
	"Outputs": {
		"ManagementVPCID": {
			"Description": "Management VPC ID",
			"Value": {
				"Fn::GetAtt": ["VPCNAT",
				"Outputs.VPCId"]
			}
		},
		"SG1id": {
			"Description": "SG1 ID",
			"Value": {
				"Fn::GetAtt": ["VPCNAT",
				"Outputs.SG1id"]
			}
		},
		"S3Name": {
			"Description": "Name of S3 bucket",
			"Value": {
				"Fn::GetAtt": ["VPCNAT",
				"Outputs.S3Name"]
			}
		},
		"QualixInstanceIP": {
			"Description": "Internal IP of QualiX instance",
			"Value": {
				"Fn::GetAtt": ["Instances",
				"Outputs.QualixInstanceIP"]
			}
		}
	}
}